<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vibenet</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#fff; }

    /* LOGIN */
    #loginScreen {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      height:100vh; background:linear-gradient(135deg, red, white);
    }
    #loginScreen h1 { font-size:28px; color:white; margin-bottom:20px; }
    #loginScreen input, #loginScreen button {
      padding:12px; font-size:16px; border:none; border-radius:5px; margin-bottom:15px;
    }
    #loginScreen input { width:80%; }
    #loginScreen button { width:50%; background:red; color:white; cursor:pointer; }

    /* APP */
    #appScreen { display:none; height:100vh; flex-direction:column; }

    .appbar {
      background:red; color:white; padding:12px; display:flex;
      justify-content:space-between; align-items:center; font-weight:bold; font-size:18px;
    }
    .search-box { display:none; padding:5px; background:#eee; }
    .search-box input { width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; }

    .tabs { display:flex; background:red; color:white; font-weight:bold; }
    .tabs div { flex:1; text-align:center; padding:10px; cursor:pointer; }
    .tabs .active { border-bottom:3px solid white; }

    .screen { display:none; height:calc(100vh - 130px); overflow-y:auto; }
    .active-screen { display:block; }

    .chat-list { list-style:none; margin:0; padding:0; }
    .chat-list li {
      display:flex; align-items:center; padding:12px; border-bottom:1px solid #ddd; cursor:pointer;
    }
    .chat-list li:hover { background:#f8f8f8; }
    .avatar {
      width:40px; height:40px; border-radius:50%; background:red; color:white;
      display:flex; justify-content:center; align-items:center; margin-right:10px; font-weight:bold;
    }

    /* CHAT */
    .chat-screen { display:none; flex-direction:column; height:100vh; }
    .messages { flex:1; overflow-y:auto; padding:10px; background:#fafafa; }
    .message { max-width:70%; margin:6px; padding:8px 12px; border-radius:12px; display:inline-block; }
    .me { background:red; color:white; align-self:flex-end; border:1px solid red; }
    .other { background:white; color:black; align-self:flex-start; border:1px solid red; }
    .input-box { display:flex; border-top:1px solid #ddd; }
    .input-box input { flex:1; padding:10px; border:none; outline:none; }
    .input-box button { background:red; border:none; color:white; padding:0 16px; cursor:pointer; }

    /* POPUP MENU */
    #menuPopup {
      position:absolute; top:50px; right:10px; background:white;
      border:1px solid #ccc; border-radius:5px; display:none; flex-direction:column;
    }
    #menuPopup button {
      border:none; background:none; padding:10px; text-align:left; cursor:pointer; width:120px;
    }
    #menuPopup button:hover { background:#eee; }

    /* PROFILE */
    #profileScreen { display:none; padding:20px; }
    #profileScreen input { width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px; }
    #profileScreen button { padding:10px 15px; background:red; border:none; color:white; border-radius:5px; cursor:pointer; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginScreen">
    <h1>Create your Vibenet ID</h1>
    <input type="text" id="userID" placeholder="Choose a unique User ID">
    <input type="text" id="displayName" placeholder="Your Name (optional)">
    <button onclick="createAccount()">Create Account</button>
  </div>

  <!-- APP -->
  <div id="appScreen">
    <div class="appbar">
      <span>‚ú® Vibenet ‚ú®</span>
      <span>
        <button onclick="toggleSearch()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">üîç</button>
        <button onclick="toggleMenu()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">‚ãÆ</button>
      </span>
    </div>

    <!-- Popup Menu -->
    <div id="menuPopup">
      <button onclick="openProfile()">Profile</button>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Search -->
    <div class="search-box" id="searchBox">
      <input type="text" id="searchInput" placeholder="Search by User ID..." onkeyup="searchUser()">
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="active" onclick="showScreen('chats')">CHATS</div>
      <div onclick="showScreen('request')">REQUEST</div>
    </div>

    <!-- Screens -->
    <div id="chats" class="screen active-screen">
      <ul class="chat-list" id="chatList"></ul>
    </div>
    <div id="request" class="screen">
      <h3 style="padding:20px;">All Users</h3>
      <ul id="requestList" class="chat-list"></ul>
    </div>

    <!-- Chat Screen -->
    <div class="chat-screen" id="chatScreen">
      <div class="appbar">
        <span id="chatName">Chat</span>
        <span onclick="closeChat()">‚Üê Back</span>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-box">
        <input type="text" id="msgInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen">
      <h2>Profile</h2>
      <label>User ID:</label>
      <input type="text" id="profileUID" readonly>
      <label>Name:</label>
      <input type="text" id="profileName">
      <button onclick="saveProfile()">Save</button>
    </div>
  </div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCI5NOdkyTLBvMsYCUJKpnFZ3Kyf77KZTM",
    authDomain: "the-vibenet.firebaseapp.com",
    databaseURL: "https://the-vibenet-default-rtdb.firebaseio.com",
    projectId: "the-vibenet",
    storageBucket: "the-vibenet.firebasestorage.app",
    messagingSenderId: "750456552470",
    appId: "1:750456552470:web:87d410021cda7ef10a0937"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUserID = null;
  let currentName = null;
  let currentChat = null;

  // Auto Login
  window.onload = function() {
    let savedID = localStorage.getItem("vibenetUserID");
    let savedName = localStorage.getItem("vibenetName");
    if (savedID) {
      currentUserID = savedID;
      currentName = savedName || savedID;
      setOnline();
      showApp();
    }
  };

  // Create Account
  function createAccount() {
    let userID = document.getElementById("userID").value.trim();
    let name = document.getElementById("displayName").value.trim() || userID;
    if (!userID) { alert("Please choose a User ID"); return; }

    db.ref("users/" + userID).once("value").then(snapshot => {
      if (snapshot.exists()) {
        alert("‚ùå This User ID already exists!");
      } else {
        db.ref("users/" + userID).set({ name:name, lastSeen:"online" });
        localStorage.setItem("vibenetUserID", userID);
        localStorage.setItem("vibenetName", name);
        currentUserID = userID;
        currentName = name;
        setOnline();
        showApp();
      }
    });
  }

  // Show App
  function showApp() {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("appScreen").style.display = "flex";
    loadUsers();
    loadRequests();
  }

  // Load Users (Chat List)
  function loadUsers() {
    const chatList = document.getElementById("chatList");
    chatList.innerHTML = "";
    db.ref("users").on("value", snapshot => {
      chatList.innerHTML = "";
      snapshot.forEach(child => {
        let uid = child.key;
        let data = child.val();
        if(uid !== currentUserID){
          let li = document.createElement("li");
          let display = data.name || uid;
          li.innerHTML = `<div class="avatar">${display[0]}</div>
                          <div><b>${display}</b><br><small>${uid}</small></div>`;
          li.onclick = ()=>openChat(uid, display);
          chatList.appendChild(li);
        }
      });
    });
  }

  // Load Requests (All Users)
  function loadRequests(){
    const reqList = document.getElementById("requestList");
    db.ref("users").on("value", snapshot => {
      reqList.innerHTML = "";
      snapshot.forEach(child=>{
        let uid = child.key;
        let data = child.val();
        if(uid !== currentUserID){
          let li = document.createElement("li");
          li.innerHTML = `<div class="avatar">${(data.name||uid)[0]}</div>
                          <div><b>${data.name||uid}</b><br><small>${uid}</small></div>`;
          li.onclick = ()=>openChat(uid, data.name||uid);
          reqList.appendChild(li);
        }
      });
    });
  }

  // Tabs
  function showScreen(id) {
    document.querySelectorAll(".tabs div").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active-screen"));
    document.getElementById(id).classList.add("active-screen");
    event.target.classList.add("active");
  }

  // Chat
  function openChat(id, display) {
    currentChat = id;
    document.querySelector(".tabs").style.display = "none";
    document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
    document.getElementById("chatScreen").style.display = "flex";
    document.getElementById("chatName").innerText = display;
    document.getElementById("messages").innerHTML = "";

    db.ref("chats/"+chatKey(id)).on("child_added", snap => {
      let msg = snap.val();
      let div = document.createElement("div");
      div.className = "message " + (msg.from===currentUserID?"me":"other");
      div.innerText = msg.text;
      document.getElementById("messages").appendChild(div);
    });
  }
  function closeChat() {
    document.querySelector(".tabs").style.display = "flex";
    document.getElementById("chats").style.display = "block";
    document.getElementById("chatScreen").style.display = "none";
    currentChat = null;
  }
  function chatKey(friend) {
    return [currentUserID, friend].sort().join("_");
  }
  function sendMessage() {
    let text = document.getElementById("msgInput").value.trim();
    if (!text || !currentChat) return;
    let key = chatKey(currentChat);
    db.ref("chats/"+key).push({
      from: currentUserID, text:text, seen:false, time:Date.now()
    });
    document.getElementById("msgInput").value = "";
  }

  // Search
  function toggleSearch() {
    let searchBox = document.getElementById("searchBox");
    searchBox.style.display = searchBox.style.display === "block" ? "none" : "block";
    if(searchBox.style.display==="block") document.getElementById("searchInput").focus();
  }
  function searchUser() {
    let filter = document.getElementById("searchInput").value.toUpperCase();
    let li = document.getElementById("chatList").getElementsByTagName("li");
    for (let i=0;i<li.length;i++) {
      let text = li[i].innerText.toUpperCase();
      li[i].style.display = text.indexOf(filter)>-1 ? "" : "none";
    }
  }

  // Profile
  function openProfile(){
    document.getElementById("chats").style.display="none";
    document.getElementById("profileScreen").style.display="block";
    document.getElementById("profileUID").value = currentUserID;
    document.getElementById("profileName").value = currentName;
    document.getElementById("menuPopup").style.display="none";
  }
  function saveProfile(){
    let newName = document.getElementById("profileName").value.trim() || currentUserID;
    db.ref("users/"+currentUserID+"/name").set(newName);
    localStorage.setItem("vibenetName", newName);
    currentName = newName;
    alert("‚úÖ Profile updated");
    document.getElementById("profileScreen").style.display="none";
    document.getElementById("chats").style.display="block";
  }

  // Menu
  function toggleMenu(){
    let menu = document.getElementById("menuPopup");
    menu.style.display = (menu.style.display==="flex"?"none":"flex");
  }

  // Logout
  function logout(){
    localStorage.clear();
    location.reload();
  }

  // Online/Offline
  function setOnline(){
    db.ref("users/"+currentUserID+"/lastSeen").set("online");
    window.addEventListener("beforeunload", ()=>{
      db.ref("users/"+currentUserID+"/lastSeen").set(Date.now());
    });
  }
</script>

</body>
</html>